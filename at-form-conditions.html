<script src="lib/business-rules/conditions-builder.js" type="text/javascript"></script>
<link rel="import" href="../at-core-theme/at-core-theme.html" />

<dom-module id="at-form-conditions">
  <style>
    #conditionsHtmlContainer {
      margin: 20px 0;
    }

    #conditionsHtmlContainer > .conditional > .remove {
      display: none;
    }

    .conditional {
      padding-left: 60px;
    }

    .conditional .all-any-none-wrapper {
      margin: 5px 20px 5px -60px;
      display: -moz-inline-stack;
      display: inline-block;
    }

    .all-any-none {
      margin-right: 10px;
    }

    .all-any-none-wrapper,
    .conditional,
    .rule {
      margin: 10px 0;
    }

    .add-rule,
    .add-condition,
    .remove {
      margin: auto 5px;
    }

    .remove {
      color: red;
    }

    .rule input {
      width: 250px;
    }

    .rule select {
      margin-right: 10px;
    }
  </style>
  <template>
    <at-core-theme></at-core-theme>
    <div>
      <h4>When these conditions are met ...</h4>
    </div>
    <div id="conditionsHtmlContainer"></div>
  </template>
  <script>
    'use strict';
    // ----------------------------------------
    // at-form-conditions definition
    // ----------------------------------------
    Polymer({
      is: 'at-form-conditions',
      properties: {
        schema: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'schemaChanged'
        },
        config: {
          type: Array,
          value: function() {
            return {};
          },
          observer: 'configChanged',
        },
        value: {
          type: Object,
          value: function() {
            return {
              kind: "all",
              conditions: [] // "all is needed because add rule interface is not displayed if conditions object is empty
            };
          },
          notify: true,
          observer: 'valueChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        }
      },
      _scopeCssViaAttr: true,
      pr_conditionsBuilder: undefined,
      pr_conditionsHtml: undefined,
      _isInternalUpdate: false,
      _callCount: 0,
      _isReady: false,
      ready: function() {
        this._isReady = true;
      },
      initBuilder: function() {
        var self = this;
        if (!this.pr_conditionsBuilder) {
          this.pr_conditionsBuilder = RuleEngineHelpers.conditionsBuilder.call(this);
          this.pr_conditionsBuilder.on('update', function(updateEvent) {
            self._callCount += 1;
            console.log("update called " + self._callCount + " times.");
            // this is microevents solution
            // conditionsBuilder provides for update event
            // update event is fired when (sub)conditions are added / removed / modified
            // self.set('value.conditions', self.collectConditionsData());
            var tmpValue = self.collectConditionsData();

            // this flag is needed to break the infinite loop
            // when internal values of the conditions change value just needs to be set
            // there is no need to recreate the html again
            self._isInternalUpdate = true;
            self.value = tmpValue;

            //self.fire('value-changed', self.value);
          });

          this.$.conditionsHtmlContainer.addEventListener('change', function (event) {
            var target = event.target;
            var updatePath = target.getAttribute('data-update-path');
            var value = target.value;
            self.set(updatePath, value, self.value);
            self.fire('value-changed', { value: self.value });

            self._callCount += 1;
            console.log("Change event triggered " + self._callCount + " times.");
          });
        }
      },
      schemaChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        if (this.__conditionsHelperFunctions.isSchemaValid(newValue)) {
          var t_config = this.__conditionsHelperFunctions.schemaToConfig(newValue);
          this.config = t_config.value.fields;
          this.value = t_config.value.data;
        }
      },
      collectConditionsData: function() {
        var conditionsData = this.pr_conditionsBuilder.collectData(this.pr_conditionsHtml);
        return conditionsData;
      },
      configChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        this.initBuilder();
        //this.pr_conditionsBuilder.setConditions(newValue);
        this._rebuildConditionsHtml();
      },
      valueChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        if (this._isInternalUpdate) {
          // this flag is needed to break the infinite loop
          // when internal values of the conditions change value just needs to be set
          // there is no need to recreate the html again
          this._isInternalUpdate = false;
          return;
        }
        this.initBuilder();
        this.pr_conditionsBuilder.setData(newValue);
        this._rebuildConditionsHtml();
      },
      _rebuildConditionsHtml: function() {
        this.removeAllChildren(this.$.conditionsHtmlContainer);
        this.__htmlHelperFunctions.buildConditionsHtml(this.$.conditionsHtmlContainer, this.config, this.value);
        //this.pr_conditionsHtml = this.pr_conditionsBuilder.buildConditionsHtml();
        //Polymer.dom(this.$.conditionsHtmlContainer).appendChild(this.pr_conditionsHtml);
        //this.disabledChanged(this.disabled, this.disabled);
        //this._isInternalUpdate = true;
        //var tmpValue = this.collectConditionsData();
        //this.value = tmpValue;
      },
      disabledChanged: function(newValue, oldValue) {
        var
          selectIndex,
          selectElement,
          selectElements = [],
          inputIndex,
          inputElement,
          inputElements = [],
          aIndex,
          aElement,
          aElements = [],
          tmp;

        if (!this._isReady) {
          return;
        }

        if (this.pr_conditionsHtml !== '') {
          tmp = this.pr_conditionsHtml.querySelectorAll('select');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, selectElements);
          }
          tmp = this.pr_conditionsHtml.querySelectorAll('input');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, inputElements);
          }
          tmp = this.pr_conditionsHtml.querySelectorAll('button');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, aElements);
          }
        }

        if (newValue) {
          for (selectIndex = 0; selectIndex < selectElements.length; selectIndex += 1) {
            selectElement = selectElements[selectIndex];
            selectElement.setAttribute('disabled', 'disabled');
          }
          for (inputIndex = 0; inputIndex < inputElements.length; inputIndex += 1) {
            inputElement = inputElements[inputIndex];
            inputElement.setAttribute('disabled', 'disabled');
          }
          for (aIndex = 0; aIndex < aElements.length; aIndex += 1) {
            aElement = aElements[aIndex];
            aElement.setAttribute('disabled', 'disabled');
          }
        } else {
          for (selectIndex = 0; selectIndex < selectElements.length; selectIndex += 1) {
            selectElement = selectElements[selectIndex];
            selectElement.removeAttribute('disabled');
          }
          for (inputIndex = 0; inputIndex < inputElements.length; inputIndex += 1) {
            inputElement = inputElements[inputIndex];
            inputElement.removeAttribute('disabled');
          }
          for (aIndex = 0; aIndex < aElements.length; aIndex += 1) {
            aElement = aElements[aIndex];
            aElement.removeAttribute('disabled');
          }
        }
      },

      removeAllChildren: function(parentElement) {
        for (var i = 0; i < Polymer.dom(parentElement).childNodes.length; i += 1) {
          Polymer.dom(parentElement).removeChild(Polymer.dom(parentElement).childNodes[i]);
        }
      },

      pushArray1IntoArray2: function(array1, array2) {
        var
          arr1Index;

        for (arr1Index = 0; arr1Index < array1.length; arr1Index += 1) {
          array2.push(array1[arr1Index]);
        }
      },

      // ----------------------------------------
      // at-form-conditions helper functions
      // ----------------------------------------
      __conditionsHelperFunctions: {
        // ----------------------------------------
        // validates the schema object
        // schema object must contain property 'properties'
        // ----------------------------------------
        isSchemaValid: function(schema) {
          var
            result = false;

          result = schema.hasOwnProperty('properties');

          return result;
        },
        // ----------------------------------------
        // converts schema to config and data
        // schema object must contain property 'properties'
        // ----------------------------------------
        schemaToConfig: function(schema) {
          var result = {
              value: {
                fields: [],
                data: {
                  kind: "all",
                  conditions: []
                }
              },
              hasErrors: false,
              errors: []
            },
            properties = schema.properties,
            propName, // property name
            propDef, // property definition
            propLabel, // property title
            propType, // property type
            field, // a new field to be added to result.value.fields
            hasCompareTargets, // bool that tells that current property has compare targets
            compareTargets, // for a given field holds other fields whose value can be compared to the given field's value
            indexOfDash // for xtype="code-*"
          ;

          // we want to iterate over all properties of schema.properties
          for (propName in properties) {
            propDef = properties[propName];
            propLabel = this.getPropertyLabel(propName, propDef);

            field = {
              label: propLabel,
              name: propName,
              operators: [],
              options: []
            }

            result.value.fields.push(field);

            // *ij* if its needed to compare fields value against a predefined list of values
            //  propDef needs to have an additional property that will provide the list of values

            propType = this.getPropertyType(propDef);
            compareTargets = this.getCompareTargets(propName, properties);
            hasCompareTargets = compareTargets.length > 0;

            switch (propType) {
              case "string":
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));
                field.operators.push(this.createOperatorDef("includes", "inclues", "text"));
                field.operators.push(this.createOperatorDef("matches regex", "matchesRegex", "text"));

                if (hasCompareTargets) {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                  field.operators.push(this.createOperatorDef("is less than", "lessThan", "select"));
                  field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "select"));
                  field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "select"));
                  field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "select"));

                  field.options.push(this.createFieldOption("Static", "static", undefined, "text"));
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                } else {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "text"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "text"));
                  field.operators.push(this.createOperatorDef("is less than", "lessThan", "text"));
                  field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "text"));
                  field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "text"));
                  field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "text"));
                }
                break;
              case "number":
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));

                if (hasCompareTargets) {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                  field.operators.push(this.createOperatorDef("is less than", "lessThan", "select"));
                  field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "select"));
                  field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "select"));
                  field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "select"));

                  field.options.push(this.createFieldOption("Static", "static", undefined, "text"));
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                } else {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "text"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "text"));
                  field.operators.push(this.createOperatorDef("is less than", "lessThan", "text"));
                  field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "text"));
                  field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "text"));
                  field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "text"));
                }
                break;
              case "boolean":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                var trueFalseOptionsArray = [{
                  name: "true",
                  label: "true"
                }, {
                  name: "false",
                  label: "false"
                }];

                field.options.push(this.createFieldOption("Static", "static", trueFalseOptionsArray, "select"));
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "enum":
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));

                var
                  enumOptions = this.getEnumOptions(propDef),
                  hasEnumOptions = enumOptions.length > 0;

                if (hasCompareTargets || hasEnumOptions) {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                } else {
                  field.operators.push(this.createOperatorDef("is equal to", "equalTo", "text"));
                  field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "text"));
                }

                if (hasEnumOptions) {
                  field.options.push(this.createFieldOption("Static", "static", enumOptions, "select"));
                } else {
                  field.options.push(this.createFieldOption("Static", "static", undefined, "text"));
                }
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }

                break;
            }
            // end switch (propType)

          }

          return result;
        },
        // ----------------------------------------
        // calculates what is the label for the property
        // ----------------------------------------
        getPropertyLabel: function(propName, propDef) {
          var result = this.capitalize(propName);

          if (propDef.hasOwnProperty('title') && propDef.title !== '') {
            result = propDef.title;
          } else if (propDef.hasOwnProperty('description' && propDef.description !== '')) {
            result = propDef.description;
          }

          return result;
        },
        // ----------------------------------------
        // calculates what is property's type
        // ----------------------------------------
        getPropertyType: function(propDef) {
          var result = propDef.type;

          if (result === "string" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
            result = propDef.xtype;
            if (result.indexOf('-') != -1) {
              indexOfDash = type.indexOf('-');
              result = type.slice(0, indexOfDash);
            }
          }

          if (result === "string" && (!propDef.hasOwnProperty('xtype') || propDef.xtype === '') && propDef.hasOwnProperty('enum') && this.isArray(propDef.enum)) {
            result = "enum";
          }

          return result;
        },
        // ----------------------------------------
        // for a given property name finds the other properties which value can be compared to this property's value
        // ----------------------------------------
        getCompareTargets: function(propName, properties) {
          var
            result = [],
            sourceDef = properties[propName],
            targetDef = {},
            propNameIndex;

          for (propNameIndex in properties) {
            if (propName !== propNameIndex) { // if names are differenct do the check
              targetDef = properties[propNameIndex];
              if (this.isCompareTarget(sourceDef, targetDef)) {
                result.push({
                  label: this.getPropertyLabel(propNameIndex, targetDef),
                  name: propNameIndex
                });
              }
            }
          }

          return result;
        },
        // ----------------------------------------
        // returns true if sourceDef and targetDef define elements whose value can be compared
        // ----------------------------------------
        isCompareTarget: function(sourceDef, targetDef) {
          if (sourceDef.type !== targetDef.type) {
            // if both have different type they are not compatible
            return false;
          }

          if (sourceDef.xtype === undefined && targetDef.xtype === undefined) {
            // if both are of the same type and do not have xtype and they are compatible
            return true;
          }

          if ((sourceDef.xtype === undefined && targetDef.xtype !== undefined) || (sourceDef.xtype !== undefined && targetDef.xtype === undefined)) {
            // if both have same type but one has xtype and other doesn't they are not compatible
            return false;
          }

          if (sourceDef.xtype !== targetDef.xtype) {
            // if both have same type but different xtypes they are not compatible
            return false;
          }

          // at this point both have the same type and same xtype

          if (sourceDef.xtype === 'enum') {
            // compare xvaluelists
            if (sourceDef.xvaluelist === undefined || targetDef.xvaluelist === undefined || sourceDef.xvaluelist !== targetDef.xvaluelist) {
              // if any of the two doesn't have xvaluelist or xvaluelists are different they are not compatible
              return false;
            }
          } else if (sourceDef.xtype === 'lookup') {
            if (sourceDef.xurl === undefined || targetDef.xurl === undefined || sourceDef.xurl !== targetDef.xurl) {
              // if any of the two doesn't have xurl or xurls are different they are not compatible
              return false;
            }
          } else {
            // xtype is not recognized; return false
            return false;
          }

          // source and target are compatible; return true
          return true;
        },
        getEnumOptions: function(propDef) {
          var
            result = [],
            value, valueList = [""],
            trimedValue, index, length;

          if (propDef.xvaluelist !== undefined && propDef.xvaluelist !== "") {
            valueList = propDef.xvaluelist.split(',');
          } else if (propDef.enum && this.isArray(propDef.enum)) {
            valueList = propDef.enum;
          } else {
            console.log("xvaluelist or enum property not specified for property definition");
            console.log(JSON.stringify(propDef, undefined, ' '));
          }

          length = valueList.length;
          for (index = 0; index < length; index += 1) {
            value = valueList[index];
            trimedValue = value.trim();
            result.push({
              name: trimedValue,
              label: this.capitalize(trimedValue)
            });
          }

          return result;
        },
        // ----------------------------------------
        // creates an operator definition
        // ----------------------------------------
        createOperatorDef: function(label, name, fieldType) {
          var result = {
            label: label,
            name: name,
            fieldType: fieldType
          }

          return result;
        },
        // ----------------------------------------
        // creates a new field option
        // ----------------------------------------
        createFieldOption: function(label, name, options, fieldType) {
          var result = {
            label: label,
            name: name
          };
          if (options !== undefined && this.isArray(options)) {
            result.options = options;
          }
          if (fieldType !== undefined && this.isString(fieldType)) {
            result.fieldType = fieldType;
          }

          return result;
        },
        // ----------------------------------------
        // capitalizes the first letter of a word
        // ----------------------------------------
        capitalize: function(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        },
        // ----------------------------------------
        // tests if obj is a javascript array
        // ----------------------------------------
        isArray: function(obj) {
          return Object.prototype.toString.call(obj) === "[object Array]";
        },
        isString: function(obj) {
          return Object.prototype.toString.call(obj) === "[object String]";
        }
      },
      // ----------------------------------------
      // end of at-form-conditions helper functions
      // ----------------------------------------

      // ----------------------------------------
      // at-form-conditions html helper functions
      // ----------------------------------------
      __htmlHelperFunctions: {
        buildConditionsHtml: function(htmlContainer, fields, data) {
          var updatePath = '';
          this.buildNodeHtml(htmlContainer, fields, data, updatePath);
        },
        buildNodeHtml: function(htmlContainer, fields, data, currentUpdatePath) {
          var
            kind = data.kind,
            index,
            condition,
            length = data.conditions.length,
            isLeaf,
            self = this,
            _fields = fields;

          // ----------------------------------------
          // build all-any-none select
          // ----------------------------------------
          var conditionsDiv = document.createElement('div');
          Polymer.dom(conditionsDiv).classList.add('conditional');
          Polymer.dom(conditionsDiv).classList.add(kind);
          Polymer.dom(htmlContainer).appendChild(conditionsDiv);

          var allAnyNoneWrapper = document.createElement('div');
          Polymer.dom(allAnyNoneWrapper).classList.add('all-any-none-wrapper');

          var allAnyNoneSelect = document.createElement('select');
          Polymer.dom(allAnyNoneSelect).classList.add('all-any-none');
          Polymer.dom(allAnyNoneSelect).setAttribute('data-update-path', this.createPath(currentUpdatePath, 'kind'));

          var option = this.createSelectOption("all", "All", kind === "all");
          Polymer.dom(allAnyNoneSelect).appendChild(option);
          option = this.createSelectOption("any", "Any", kind === "any");
          Polymer.dom(allAnyNoneSelect).appendChild(option);
          option = this.createSelectOption("none", "None", kind === "none");
          Polymer.dom(allAnyNoneSelect).appendChild(option);
          Polymer.dom(allAnyNoneWrapper).appendChild(allAnyNoneSelect);

          var span = document.createElement('span');
          Polymer.dom(span).innerHTML = "of the following conditions:";

          Polymer.dom(allAnyNoneWrapper).appendChild(span);
          Polymer.dom(conditionsDiv).appendChild(allAnyNoneWrapper);

          // ------------------------------
          // create add condition button
          // ------------------------------

          var addRuleLink = document.createElement("button");
          Polymer.dom(addRuleLink).classList.add('add-rule');
          Polymer.dom(addRuleLink).setAttribute('type', 'button');
          Polymer.dom(addRuleLink).innerHTML = "Add Condition";

          addRuleLink.addEventListener('click', function(e) {
            var _fields = fields;
            var _htmlContainer = conditionsDiv;
            var aField = _fields[0];

            var data = {
              name: aField.name,
              operator: aField.operators[0],
              compareTo: "text",
              value: ""
            };
            self.buildLeafHtml(_htmlContainer, _fields, data);

            console.log('Add condition clicked.');
          });
          Polymer.dom(conditionsDiv).appendChild(addRuleLink);

          // ------------------------------
          // create add sub-condition button
          // ------------------------------
          var addConditionLink = document.createElement("button");
          Polymer.dom(addConditionLink).classList.add('add-condition');
          Polymer.dom(addConditionLink).setAttribute('type', 'button');
          Polymer.dom(addConditionLink).innerHTML = "Add Sub-Condition";

          addConditionLink.addEventListener('click', function(e) {

            var f = _this.fields[0];
            var newField = {
              kind: "all",
              conditions: [{
                name: f.value,
                operator: f.operators[0],
                value: null
              }]
            };
            Polymer.dom(div).appendChild(_this.buildNodeHtml(newField));

            console.log('Add sub-condition clicked.');
          });
          Polymer.dom(conditionsDiv).appendChild(addConditionLink);

          // ------------------------------
          // create remove condition / sub-condition button
          // ------------------------------
          var removeLink = document.createElement('button');
          Polymer.dom(removeLink).setAttribute('type', 'button');
          Polymer.dom(removeLink).classList.add('remove');
          Polymer.dom(removeLink).innerHTML = 'Remove This Sub-Condition';

          removeLink.addEventListener('click', function(e) {
            debugger;

            Polymer.dom(conditionsDiv.parentElement).removeChild(conditionsDiv);

            console.log('Remove sub-condition clicked.');
          });
          Polymer.dom(conditionsDiv).appendChild(removeLink);

          // ------------------------------
          // build the rules or conditions for this node
          // ------------------------------
          for (index = 0; index < length; index += 1) {
            condition = data.conditions[index];
            isLeaf = condition.kind === undefined;
            var updatePath = this.createPath(currentUpdatePath, "conditions."+index);

            if (isLeaf) {
              this.buildLeafHtml(conditionsDiv, fields, condition, updatePath);
            } else {
              this.buildNodeHtml(conditionsDiv, fields, condition, updatePath);
            }
          }
        },
        // ------------------------------
        // builds the html structure for the rule
        // ------------------------------
        buildLeafHtml: function(htmlContainer, fields, data, updatePath) {
          data.compareTo = data.compareTo !== undefined ? data.compareTo : 'text';
          if (data.compareTo !== 'text' && data.compareTo !== 'field') {
            var errorMsgTemplate = "Rule {0} has incorrect value for compareTo property. Provided value is {1} but valid values are text or field. This rule will not be shown in the editor";
            var errorMsg = formatString(errorMsgTemplate, a, b, c);
            console.log(errorMsg);
          }

          // ------------------------------
          // create the html container for the rule
          // ------------------------------
          var leafContainer = document.createElement('div');
          Polymer.dom(leafContainer).classList.add('rule');
          Polymer.dom(htmlContainer).appendChild(leafContainer);
          // ------------------------------
          // create the select element for selecting the field(s)
          // ------------------------------
          var fieldSelect = this.createFieldSelect(fields, data);
          Polymer.dom(fieldSelect).setAttribute('data-update-path', this.createPath(updatePath, 'name'));
          Polymer.dom(leafContainer).appendChild(fieldSelect);

          fieldSelect.addEventListener('change', function(event) {
            debugger;
          });
          // ------------------------------
          // create the select element for selecting operator(s)
          // ------------------------------
          var operatorSelect = this.createOperatorSelect(fields, data);
          Polymer.dom(operatorSelect).setAttribute('data-update-path', this.createPath(updatePath, 'operator'));
          Polymer.dom(leafContainer).appendChild(operatorSelect);

          operatorSelect.addEventListener('change', function(event) {
            debugger;
          });

          // ------------------------------
          // create the value part for the rule based on field type
          // and compareTo value
          // ------------------------------
          // find the selected operator
          var selectedOperator = Polymer.dom(operatorSelect).querySelector('option:checked');
          var selectedField = this.getFieldByName(fields, data.name);
          var operatorCompareToSelect = this.createOperatorCompareToSelect(selectedOperator, selectedField);
          Polymer.dom(operatorCompareToSelect).setAttribute('data-update-path', this.createPath(updatePath, 'compareTo'));
          Polymer.dom(leafContainer).appendChild(operatorCompareToSelect);

          operatorCompareToSelect.addEventListener('change', function(event) {
            debugger;
          });

          // ------------------------------
          // if compareTo is text create an input type=text
          // if compareTo is field create a select and populate it with options
          // ------------------------------
          var selectedCompareTo = Polymer.dom(operatorCompareToSelect).querySelector('option:checked');
          if (selectedCompareTo !== undefined) {
            var valueHtml = this.createValueHtml(selectedCompareTo, data, updatePath);
            Polymer.dom(leafContainer).appendChild(valueHtml);
            valueHtml.addEventListener('change', function(event) {
              debugger;
            });
          }


          // ------------------------------
          // create the remove button
          // ------------------------------
          var removeLink = document.createElement('button');
          Polymer.dom(removeLink).setAttribute('type', 'button');
          Polymer.dom(removeLink).classList.add('remove');
          Polymer.dom(removeLink).innerHTML = "Remove";
          Polymer.dom(leafContainer).appendChild(removeLink);

          removeLink.addEventListener('click', function(event) {
            debugger;

            console.log('Remove condition clicked.');
          });
        },
        createFieldSelect: function(fields, data) {
          var fieldSelect = document.createElement('select');
          Polymer.dom(fieldSelect).classList.add('field');
          var index, length = fields.length,
            field, option;

          for (index = 0; index < length; index += 1) {
            field = fields[index];
            option = this.createSelectOption(field.name, field.label, data.name === field.name);
            Polymer.dom(option).setAttribute('options', JSON.stringify(field.options));
            Polymer.dom(fieldSelect).appendChild(option);
          }
          return fieldSelect;
        },
        createOperatorSelect: function(fields, data) {
          var fieldName = data.name;
          var operators = this.operatorsFor(fields, fieldName);
          var i, length = operators.length,
            operator, option;
          var operatorSelect = document.createElement('select');
          Polymer.dom(operatorSelect).classList.add('operator');

          for (i = 0; i < length; i += 1) {
            operator = operators[i];
            option = this.createSelectOption(operator.name, operator.label, operator.name === data.operator);
            Polymer.dom(option).setAttribute('data-field-type', operator.fieldType);
            Polymer.dom(option).setAttribute('data-compare-to', data.compareTo);
            Polymer.dom(operatorSelect).appendChild(option);
          }

          return operatorSelect;
        },
        operatorsFor: function(fields, fieldName) {
          var i, length = fields.length,
            field;
          for (i = 0; i < length; i += 1) {
            var field = fields[i];
            if (field.name === fieldName) {
              return field.operators;
            }
          }
        },
        getFieldByName: function(fields, fieldName) {
          var i, length = fields.length,
            field;

          for (i = 0; i < length; i += 1) {
            field = fields[i];
            if (field.name === fieldName) {
              break;
            }
          }

          return field;
        },
        createSelectOption: function(value, text, selected) {
          var option = document.createElement("option");
          option.value = value;
          option.text = text;
          option.selected = selected;

          return option;
        },
        createOperatorCompareToSelect: function(operatorHtml, field) {
          var fieldType = operatorHtml.getAttribute('data-field-type');
          var compareTo = operatorHtml.getAttribute('data-compare-to');
          var options = field.options,
            i, length = options.length,
            option, htmlOption;

          var result = '';
          if (fieldType === "none") {
            result = document.createElement('input');
            Polymer.dom(result).setAttribute('type', 'hidden');
            Polymer.dom(result).classList.add('compareTo');
          } else if (fieldType === "select") {
            result = document.createElement('select');
            Polymer.dom(result).classList.add('compareTo');

            for (var i = 0; i < length; i++) {
              option = options[i];
              htmlOption = this.createSelectOption(option.name, option.label || option.name, compareTo === option.name);
              Polymer.dom(htmlOption).setAttribute('data-field-type', option.fieldType);
              if (option.options !== undefined) {
                Polymer.dom(htmlOption).setAttribute('data-options', JSON.stringify(option.options));
              }
              Polymer.dom(result).appendChild(htmlOption);
            }
          }

          return result;
        },
        createValueHtml: function(selectedCompareTo, data, updatePath) {
          var result = '';
          var fieldType = selectedCompareTo.getAttribute('data-field-type');
          var optionsJson = selectedCompareTo.getAttribute('data-options');
          var options = JSON.parse(optionsJson);

          switch (fieldType) {
            case "text":
              result = document.createElement('input');
              Polymer.dom(result).setAttribute('type', 'text');
              Polymer.dom(result).classList.add('value');
              Polymer.dom(result).setAttribute('data-update-path', this.createPath(updatePath, 'value'));
              result.value = data.value;
              break;
            case "textarea":
              result = document.createElement('textarea');
              Polymer.dom(result).classList.add('value');
              Polymer.dom(result).setAttribute('data-update-path', this.createPath(updatePath, 'value'));
              result.value = data.value;
              break;
            case "select":
              result = document.createElement('select');
              Polymer.dom(result).setAttribute('data-update-path', this.createPath(updatePath, 'value'));
              Polymer.dom(result).classList.add('value');

              for (var i = 0; i < options.length; i++) {
                var option = options[i];
                var htmlOption = this.createSelectOption(option.name, option.label || option.name, data.value === option.name);
                Polymer.dom(result).appendChild(htmlOption);
              }
              break;
          }

          return result;
        },
        createPath: function (previousPath, step) {
          var result = '';
          if (previousPath === '') {
            result = step;
          } else {
            result = previousPath + "." + step;
          }

          return result;
        }
      }
      // ----------------------------------------
      // end of at-form-conditions html helper functions
      // ----------------------------------------
    });
    // ----------------------------------------
    // end of at-form-conditions definition
    // ----------------------------------------
  </script>
</dom-module>
