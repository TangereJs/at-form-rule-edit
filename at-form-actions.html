<script src="lib/business-rules/actions-builder.js" type="text/javascript"></script>

<!--
`at-form-actions` is an element for specifying actions

'config' property specifies the configuration for available actions

'value' property holds the specified actions. It can be used to provide initial actions.

'schema' property is used to generate the 'config' based on 'at-core-form's' json schmea

  How to specify 'config'

  There are four available actions to be specified: alert, update field's value, copy field's value to another field and set field's state
  config = {
  // specification for alert action
  "alert": { // action's name
    label: "Show alert" // action's label
  },
  // specification for update field action
  "updateField": {
    label: "Update Field",
    fields: [{
      label: "<field-label>", // field label
      name: "<field-name>", // field name
      updateTo: "value" // field will be updated with value that user types
    },{
      label: "<field-label>" // field label
      name: "<field-name>", // field name
      updateTo: "values", // field will be updated with predefined values specified in values property
      values: [{
        label: "<value-label>",
        name: "<value-value"
      }]
    }]
  },
  // specification for copy field value action
  "copyFieldValue": { // action name
    label: "Copy Field Value", // action label
    fields: [{
      label: "<field-label", // source field label
      name: "<field-name>", // source field name
      copyTo: [{
        label: "<field-label>", // destination field label
        name: "<field-name>" // destination field name
      }]
    }]
  },
  // specification for set field state action
  "setFieldState":{
    label: "Set Field State",
    fields:[
      label: "<field-label", // source field label
      name: "<field-name>", // source field name
      states: [{
        label: "Optional",
        name: "optional"
      },{
        label: "Required",
        name: "required"
      },{
        label: "Disabled",
        name: "disabled"
      },{
        label: "Hidden",
        name: "hidden"
      }]
    ]
  }
};

How to specify value

value = [
  {
    actionName: 'alert',
    message: "<message-text>"
  },
  {
    actionName: 'updateField',
    fieldName: "<field-name>",
    updateTo: "<value-to-update-to>"
  },
  {
    actionName: 'copyFieldValue',
    fieldName: "<source-field-name>",
    copyTo: "<destination-field-name>"
  },
  {
    actionName: 'setFieldState',
    fieldName: "<field-name>",
    state: "<state-name>" // one of [optional, required, disabled or hidden]
  }
];
-->
<dom-module id="at-form-actions">
  <style>
    #actionsHtmlContainer {
      margin: 20px 0;
    }

    #actionsHtmlContainer > .conditional > .remove {
      display: none;
    }

    .action-buttons {
      margin: 20px 0;
    }

    .action {
      margin: 10px 0;
    }

    .action .subfields,
    .action .subfields .field {
      display: inline;
    }

    .action label {
      display: none;
    }

    .action select,
    .action input,
    .action textarea {
      margin-right: 10px;
    }

    .action textarea,
    .action input {
      width: 250px;
    }

    .action textarea {
      vertical-align: top;
      height: 50px;
    }
  </style>
  <template>
    <h3>Do these actions...</h3>
    <div id="actionsHtmlContainer"></div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-form-actions',
      properties: {
        schema: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'schemaChanged'
        },
        config: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'configChanged'
        },
        value: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'valueChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        }
      },
      _debug_update_calls: 0,
      _isReady: false,
      _scopeCssViaAttr: true,
      ready: function() {
        this._isReady = true;
        var self = this;
        this.$.actionsHtmlContainer.addEventListener('change', function(event) {

          self._debug_update_calls += 1;
          console.log('Update event triggered ' + self._debug_update_calls + " times.");
        });
      },
      schemaChanged: function(newValue, oldValue) {
        if (newValue.properties) {
          var t_config = this.schemaToConfig(newValue);
          this.config = t_config;
        }
      },
      configChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        this._rebuildActionsHtml();
      },
      valueChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        this._rebuildActionsHtml();
      },
      _rebuildActionsHtml: function() {
        Polymer.dom(this.$.actionsHtmlContainer).innerHTML = '';
        this.buildActionsHtml(this.$.actionsHtmlContainer, this.config, this.value);
        this.disabledChanged(this.disabled, this.disabled);
      },
      disabledChanged: function(newValue, oldValue) {
        var
          selectIndex,
          selectElement,
          selectElements = [],
          inputIndex,
          inputElement,
          inputElements = [],
          aIndex,
          aElement,
          aElements = [],
          textAreaIndex,
          textAreaElement,
          textAreaElements = [],
          tmp;

        if (this.pr_actionsHtml) {
          tmp = this.pr_actionsHtml.querySelectorAll('select');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, selectElements);
          }
          tmp = this.pr_actionsHtml.querySelectorAll('input');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, inputElements);
          }
          tmp = this.pr_actionsHtml.querySelectorAll('button');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, aElements);
          }
          tmp = this.pr_actionsHtml.querySelectorAll('textarea');
          if (tmp.length > 0) {
            this.pushArray1IntoArray2(tmp, textAreaElements);
          }
        }

        if (newValue) {
          for (selectIndex = 0; selectIndex < selectElements.length; selectIndex += 1) {
            selectElement = selectElements[selectIndex];
            selectElement.setAttribute('disabled', 'disabled');
          }
          for (inputIndex = 0; inputIndex < inputElements.length; inputIndex += 1) {
            inputElement = inputElements[inputIndex];
            inputElement.setAttribute('disabled', 'disabled');
          }
          for (aIndex = 0; aIndex < aElements.length; aIndex += 1) {
            aElement = aElements[aIndex];
            aElement.setAttribute('disabled', 'disabled');
          }
          for (textAreaIndex = 0; textAreaIndex < textAreaElements.length; textAreaIndex += 1) {
            textAreaElement = textAreaElements[textAreaIndex];
            textAreaElement.setAttribute('disabled', 'disabled');
          }
        } else {
          for (selectIndex = 0; selectIndex < selectElements.length; selectIndex += 1) {
            selectElement = selectElements[selectIndex];
            selectElement.removeAttribute('disabled');
          }
          for (inputIndex = 0; inputIndex < inputElements.length; inputIndex += 1) {
            inputElement = inputElements[inputIndex];
            inputElement.removeAttribute('disabled');
          }
          for (aIndex = 0; aIndex < aElements.length; aIndex += 1) {
            aElement = aElements[aIndex];
            aElement.removeAttribute('disabled');
          }
          for (textAreaIndex = 0; textAreaIndex < textAreaElements.length; textAreaIndex += 1) {
            textAreaElement = textAreaElements[textAreaIndex];
            textAreaElement.removeAttribute('disabled');
          }
        }
      },

      schemaToConfig: function(schema) {
        var stateOptions = [{
          label: "Optional",
          name: "optional"
        }, {
          label: "Required",
          name: "required"
        }, {
          label: "Hidden",
          name: "hidden"
        }, {
          label: "Disabled",
          name: "disabled"
        }];

        var result = {
          alert: {
            label: "Show alert"
          },
          updateField: {
            label: "Update Field",
            fields: []
          },
          copyFieldValue: {
            label: "Copy Field Value",
            fields: []
          },
          setFieldState: {
            label: "Set Field State",
            fields: []
          }
        };

        var
          properties = schema.properties,
          propName,
          propDef,
          updateFieldOption,
          copyFieldValueOption,
          setFieldStateOption,
          propType,
          value;

        for (propName in properties) {
          propDef = properties[propName];
          propType = this.getPropertyType(propDef);

          switch (propType) {
            case "string":
            case "number":
            case "lookup":
              if (properties[propName].xtype === "enum" && properties[propName].xvaluelist !== undefined) {
                var updateFieldOptions = [];
                var valueList = properties[propName].xvaluelist.split(',');
                for (value in valueList) {
                  var trimValue = valueList[value].trim();
                  updateFieldOptions.push({
                    name: trimValue,
                    label: trimValue
                  });
                }
                updateFieldOption = {
                  label: this.capitalize(propName + " to"),
                  name: propName,
                  updateTo: "values",
                  values: updateFieldOptions
                };
              } else {
                updateFieldOption = {
                  label: this.capitalize(propName + " to"),
                  name: propName,
                  updateTo: "text"
                };
              }

              break;
            case "bool":
            case "boolean":
              var booleanOptions = [{
                name: "true",
                label: "true"
              }, {
                name: "false",
                label: "false"
              }];

              updateFieldOption = {
                label: this.capitalize(propName + " to"),
                name: propName,
                updateTo: "values",
                values: booleanOptions
              };

              break;
            case "enum":
              var condConfOptions;
              if (propDef.options) {
                condConfOptions = propDef.options
              } else if (propDef.xvaluelist) {
                condConfOptions = [];
                var valueListItems = propDef.xvaluelist.split(',');
                for (var vlItemsIndex = 0; vlItemsIndex < valueListItems.length; vlItemsIndex += 1) {
                  var trimmedValue = valueListItems[vlItemsIndex].trim();
                  var ccOption = {
                    label: trimmedValue,
                    name: trimmedValue
                  };
                  condConfOptions.push(ccOption);
                }
              }

              updateFieldOption = {
                label: this.capitalize(propName + " to"),
                name: propName,
                updateTo: "values",
                values: condConfOptions
              };

              break;
          }
          result.updateField.fields.push(updateFieldOption);

          // any field type can have its value copied to another field
          var copyFieldValueField = this.getCopyFieldValueFieldFor(propName, properties);
          if (copyFieldValueField.copyTo.length > 0) {
            // if there is at least one copy target add field to copyFieldValue action
            result.copyFieldValue.fields.push(copyFieldValueField);
          }

          // any field type can have its state set
          setFieldStateOption = {
            label: this.capitalize(propName),
            name: propName,
            states: stateOptions
          };

          result.setFieldState.fields.push(setFieldStateOption);
        }
        return result;
      },

      // ----------------------------------------
      // calculates what is property's type
      // ----------------------------------------
      getPropertyType: function(propDef) {
        var result = propDef.type;

        if (result === "string" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
          result = propDef.xtype;
          if (result.indexOf('-') != -1) {
            indexOfDash = type.indexOf('-');
            result = type.slice(0, indexOfDash);
          }
        }

        if (result === "string" && (!propDef.hasOwnProperty('xtype') || propDef.xtype === '') && propDef.hasOwnProperty('enum') && this.isArray(propDef.enum)) {
          result = "enum";
        }

        return result;
      },

      // ------------------------------
      // capitalizes the first letter or a word
      // ------------------------------
      capitalize: function(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      },

      // ----------------------------------------
      // for given property name and properties creates a copyFieldValue action
      // entry for its fields property
      // ----------------------------------------
      getCopyFieldValueFieldFor: function(propName, properties) {
        var result = {
          label: this.capitalize(propName + " to"),
          name: propName,
          copyTo: []
        };

        var
          property,
          condConf = properties[propName];

        for (property in properties) {
          if (propName !== property) { // if names are different
            var propertyConf = properties[property];
            var isTarget = this.isCopyTarget(condConf, propertyConf);
            if (isTarget) {
              result.copyTo.push({
                label: this.capitalize(property),
                name: property
              });
            }
          }
        }

        return result;
      },

      /**
       * Determines whether targetConf can be a copy target for condConf
       * @return true if it can, false otherwise
       */
      isCopyTarget: function(condConf, targetConf) {

        if (condConf.type !== targetConf.type) {
          // if both have different type they are not compatible
          return false;
        }

        if (condConf.xtype === undefined && targetConf.xtype === undefined) {
          // if both are of the same type and do not have xtype and they are compatible
          return true;
        }

        if ((condConf.xtype === undefined && targetConf.xtype !== undefined) || (condConf.xtype !== undefined && targetConf.xtype === undefined)) {
          // if both have same type but one has xtype and other doesn't they are not compatible
          return false;
        }

        if (condConf.xtype !== targetConf.xtype) {
          // if both have same type but different xtypes they are not compatible
          return false;
        }

        // at this point both have the same type and same xtype

        if (condConf.xtype === 'enum') {
          // compare xvaluelists
          if (condConf.xvaluelist === undefined || targetConf.xvaluelist === undefined || condConf.xvaluelist !== targetConf.xvaluelist) {
            // if any of the two doesn't have xvaluelist or xvaluelists are different they are not compatible
            return false;
          }
        } else if (condConf.xtype === 'lookup') {
          if (condConf.xurl === undefined || targetConf.xurl === undefined || condConf.xurl !== targetConf.xurl) {
            // if any of the two doesn't have xurl or xurls are different they are not compatible
            return false;
          }
        } else {
          // xtype is not recognized; return false
          return false;
        }

        // source and target are compatible; return true
        return true;
      },

      pushArray1IntoArray2: function(array1, array2) {
        var
          arr1Index;

        for (arr1Index = 0; arr1Index < array1.length; arr1Index += 1) {
          array2.push(array1[arr1Index]);
        }
      },
      addAction: function(actionData) {
        this.value.push(actionData);
        this.fire('value-changed', {
          value: this.value
        });
      },
      removeAction: function(path) {
        debugger;
      },
      buildActionsHtml: function(htmlContainer, config, data) {
        var self = this;
        // build the container for the actions
        var actionsContainer = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(actionsContainer);
        Polymer.dom(actionsContainer).classList.add('actions');

        var i, actionData, actionConfig, length = data.length,
          path;
        for (i = 0; i < length; i++) {
          actionData = data[i];
          path = (i).toString();
          this.buildActionHtml(actionsContainer, config, actionData, path);
        }

        // build the container for the add action button
        var buttonContainer = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(buttonContainer);
        Polymer.dom(buttonContainer).classList.add('action-buttons');
        // create the add action button
        var addActionButton = document.createElement('button');
        Polymer.dom(addActionButton).setAttribute('type', 'button');
        Polymer.dom(addActionButton).classList.add('add');
        Polymer.dom(addActionButton).innerHTML = "Add Action";
        Polymer.dom(buttonContainer).appendChild(addActionButton);

        addActionButton.addEventListener('click', function(event) {
          var _container = actionsContainer;
          var newAction = {
            actionName: 'alert',
            message: 'Type your message here...'
          };
          var path = (self.value.length).toString();
          self.buildActionHtml(_container, newAction, path);
          self.addAction(newAction);
        });
      },
      buildActionHtml: function(htmlContainer, config, data, path) {
        var actionHtml = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(actionHtml);
        Polymer.dom(actionHtml).classList.add('action');

        var actionSelect = this.createActionSelect(config, data, path);
        Polymer.dom(actionHtml).appendChild(actionSelect);

        var subFieldsContainer = document.createElement('div');
        Polymer.dom(subFieldsContainer).classList.add('subfields');
        Polymer.dom(actionHtml).appendChild(subFieldsContainer);
        var actionName = actionSelect.value;
        var actionConfig = config[actionName];

        if (actionName === 'alert') {
          this.createAlertHtml(subFieldsContainer, data, path);
        } else if (actionName === 'updateField') {
          this.createUpdateFieldHtml(subFieldsContainer, actionConfig, data, path);
        } else if (actionName === 'copyFieldValue') {
          this.createCopyFieldValueHtml(subFieldsContainer, actionConfig, data, path);
        } else if (actionName === 'setFieldState') {
          this.createSetFieldStateHtml(subFieldsContainer, actionConfig, data, path);
        }

        var removeButton = document.createElement('button');
        Polymer.dom(removeButton).setAttribute('type', 'button');
        Polymer.dom(removeButton).classList.add('remove');
        Polymer.dom(removeButton).innerHTML = 'Remove Action';
        Polymer.dom(actionHtml).appendChild(removeButton);

        removeButton.addEventListener('click', function (event) {
          debugger;
        });
      },
      createActionSelect: function(config, data, path) {
        var select = document.createElement('select');
        Polymer.dom(select).classList.add('action-select');
        Polymer.dom(select).setAttribute('data-update-path', this.createPath(path, 'actionName'));

        var actionName, actionConfig, actionLabel, selectOption;
        for(actionName in config) {
          actionConfig = config[actionName];
          actionLabel = actionConfig.label;
          selectOption = this.createSelectOption(actionName, actionLabel, actionName === data.actionName);
          Polymer.dom(select).appendChild(selectOption);
        }

        return select;
      },
      createSelectOption: function(value, label, selected) {
        var option = document.createElement('option');

        option.value = value;
        option.text = label;
        option.selected = selected;

        return option;
      },
      createAlertHtml: function(htmlContainer, data, path) {
        var textarea = document.createElement('textarea');
        Polymer.dom(textarea).setAttribute('data-update-path', this.createPath(path, 'message'));
        textarea.value= data.message;
        Polymer.dom(htmlContainer).appendChild(textarea);
      },
      createUpdateFieldHtml: function (htmlContainer, config, data, path) {

      },
      createCopyFieldValueHtml: function (htmlContainer, config, data, path) {

      },
      createSetFieldStateHtml: function (htmlContainer, config, data, path) {

      },
      createPath: function(previousPath, step) {
        var result = '';
        if (previousPath === '') {
          result = step;
        } else {
          result = previousPath + "." + step;
        }

        return result;
      }

    });
  </script>
</dom-module>
