<link rel="import" href="../polymer/polymer.html">

<script src="lib/business-rules/conditions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/actions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/rule-engine.js" type="text/javascript"></script>

<polymer-element name="at-form-rule-edit">

  <template>
    <style>
      #conditions, #actions {
        margin: 20px 0;
      }

        #conditions > .conditional > .remove, #actions > .conditional > .remove {
          display: none;
        }

      #error_message_wrapper {
        margin: 20px 0;
      }

      .conditional {
        padding-left: 60px;
      }

        .conditional .all-any-none-wrapper {
          margin: 5px 20px 5px -60px;
          display: -moz-inline-stack;
          display: inline-block;
        }

      .all-any-none {
        margin-right: 10px;
      }

      .all-any-none-wrapper, .conditional, .rule {
        margin: 10px 0;
      }

      .add-rule, .add-condition, .remove {
        margin: auto 5px;
      }

      .remove {
        color: red;
      }

      .rule input {
        width: 250px;
      }

      .rule select {
        margin-right: 10px;
      }

      .action-buttons {
        margin: 20px 0;
      }

      .action {
        margin: 10px 0;
      }

        .action .subfields, .action .subfields .field {
          display: inline;
        }

        .action label {
          display: none;
        }

        .action select, .action input, .action textarea {
          margin-right: 10px;
        }

        .action textarea, .action input {
          width: 250px;
        }

        .action textarea {
          vertical-align: top;
          height: 50px;
        }
    </style>

    <h3>When these conditions are met...</h3>
    <div id="conditions"></div>

    <h3>Do these actions...</h3>
    <div id="actions"></div>

    <content></content>
  </template>

  <script>
    (function () {
      Polymer('at-form-rule-edit', {
        publish: {
          conditions: [],
          actions: [],
          conditionsBuilder: {},
          conditionsHtml: '',
          actionsBuilder: {},
          actionsHtml: ''
        },
        ready: function () {
        },
        conditionsChanged: function (oldValue, newValue) {
          conditions = newValue;
          initializeConditions(this);
        },
        actionsChanged: function (oldValue, newValue) {
          actions = newValue;
          initializeActions(this);
        },

        collectConditionsData: function () {
          var conditionsData = this.conditionsBuilder.collectData(this.conditionsHtml);
          return conditionsData;
        },

        collectActionsData: function () {
          var actionsData = this.actionsBuilder.collectData(undefined, this.actionsHtml);
          return actionsData;
        }
      });

      initializeConditions = function (pElement) {
        pElement.conditionsBuilder = RuleEngineHelpers.conditionsBuilder(pElement.conditions);
        pElement.conditionsHtml = pElement.conditionsBuilder.buildConditionsHtml();
        pElement.$.conditions.appendChild(pElement.conditionsHtml);
      }

      initializeActions = function (pElement) {
        pElement.actionsBuilder = RuleEngineHelpers.actionsBuilder(pElement.actions);
        pElement.actionsHtml = pElement.actionsBuilder.buildActionsHtml();
        pElement.$.actions.appendChild(pElement.actionsHtml);
      }
    })();
  </script>

</polymer-element>
