<link rel="import" href="../polymer/polymer.html">

<script src="lib/business-rules/conditions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/actions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/rule-engine.js" type="text/javascript"></script>

<dom-module id="at-form-rule-edit">

  <template>
    <style>
      #conditions,
      #actions {
        margin: 20px 0;
      }
      
      #conditions > .conditional > .remove,
      #actions > .conditional > .remove {
        display: none;
      }
      
      #error_message_wrapper {
        margin: 20px 0;
      }
      
      .conditional {
        padding-left: 60px;
      }
      
      .conditional .all-any-none-wrapper {
        margin: 5px 20px 5px -60px;
        display: -moz-inline-stack;
        display: inline-block;
      }
      
      .all-any-none {
        margin-right: 10px;
      }
      
      .all-any-none-wrapper,
      .conditional,
      .rule {
        margin: 10px 0;
      }
      
      .add-rule,
      .add-condition,
      .remove {
        margin: auto 5px;
      }
      
      .remove {
        color: red;
      }
      
      .rule input {
        width: 250px;
      }
      
      .rule select {
        margin-right: 10px;
      }
      
      .action-buttons {
        margin: 20px 0;
      }
      
      .action {
        margin: 10px 0;
      }
      
      .action .subfields,
      .action .subfields .field {
        display: inline;
      }
      
      .action label {
        display: none;
      }
      
      .action select,
      .action input,
      .action textarea {
        margin-right: 10px;
      }
      
      .action textarea,
      .action input {
        width: 250px;
      }
      
      .action textarea {
        vertical-align: top;
        height: 50px;
      }
    </style>
    <h3>When these conditions are met...</h3>
    <div id="conditions"></div>

    <h3>Do these actions...</h3>
    <div id="actions"></div>

    <content></content>
  </template>
</dom-module>

<script>
  (function () {
    Polymer({
      is: 'at-form-rule-edit',
      properties: {
        // this is the schema part
        ruleConfig: {
          type: Object,
          value: function () {
            return {
              conditions: {},
              actions: {}
            };
          },
          observer: 'ruleConfigChanged'
        },
        // this is the data part
        value: {
          type: Object,
          value: function () {
            return {
              conditions: {
                "all": [] // "all is needed because add rule interface is not displayed if conditions object is empty
              },
              actions: {}
            };
          },
          notify: true,
          observer: 'valueChanged'
        },
        schema: {
          type: Object,
          value: '',
          observer: 'schemaChanged'
        },
        defaultConditions: true,
        defaultActions: true,
      },
      conditionsArray: [], // this is used to avoid double conditions object
      actionsArray: [], // this is used to avoid double conditions object
      conditionsBuilder: false,
      conditionsHtml: '',
      actionsBuilder: false,
      actionsHtml: '',
      _isReady: false,
      _scopeCssViaAttr: true,
      ready: function () {
        this._isReady = true;
      },
      initBuilders: function () {
        var self = this;
        if (!this.conditionsBuilder) {
          this.conditionsBuilder = RuleEngineHelpers.conditionsBuilder.call(this);
          this.conditionsBuilder.on('update', function (updateEvent) {
            // this is microevents solution
            // conditionsBuilder provides for update event
            // update event is fired when (sub)conditions are added / removed / modified
            // self.set('value.conditions', self.collectConditionsData());            
            self.value.conditions = self.collectConditionsData();
            self.fire('value-changed', self.value);
          });
        }
        if (!this.actionsBuilder) {
          this.actionsBuilder = RuleEngineHelpers.actionsBuilder.call(this);
          this.actionsBuilder.on('update', function (updateEvent) {
            // this is microevents solution
            // conditionsBuilder provides for update event
            // update event is fired when (sub)conditions are added / removed / modified
            //            self.set('value.actions', self.collectActionsData());
            self.value.actions = self.collectActionsData();
            self.fire('value-changed', self.value);
          });
        }
      },
      ruleConfigChanged: function (newValue, oldValue) {
        this.initBuilders();
        if (this.ruleConfig && this.ruleConfig.conditions) {
          this.conditionsBuilder.setConditions(this.ruleConfig.conditions);
          this._rebuildConditionsHtml();
        }
        if (this.ruleConfig && this.ruleConfig.actions) {
          this.actionsBuilder.setActions(this.ruleConfig.actions);
          this._rebuildActionsHtml();
        }
      },
      valueChanged: function (newValue, oldValue) {
        this.initBuilders();
        if (this.value && this.value.conditions) {
          this.conditionsBuilder.setData(this.value.conditions);
          this._rebuildConditionsHtml();
        }
        if (this.value && this.value.actions) {
          this.actionsBuilder.setData(this.value.actions);
          this._rebuildActionsHtml();
        }
      },
      _rebuildConditionsHtml: function () {
        removeAllChildren(this.$.conditions);
        this.conditionsHtml = this.conditionsBuilder.buildConditionsHtml();
        Polymer.dom(this.$.conditions).appendChild(this.conditionsHtml);
      },
      _rebuildActionsHtml: function () {
        removeAllChildren(this.$.actions);
        this.actionsHtml = this.actionsBuilder.buildActionsHtml();
        Polymer.dom(this.$.actions).appendChild(this.actionsHtml);
      },

      schemaChanged: function (newValue, oldValue) {
        if (this._isReady) {
          this.conditionsChanged(newValue, {});
          this.actionsChanged(newValue, {});
        }
      },
      conditionsChanged: function (newValue, oldValue) {
        if (this._isReady) {
          removeAllChildren(this.$.conditions);
          if (newValue.fields === undefined && newValue.data === undefined) {
            this.conditionsArray = JSONSchemaToConditionsConfig(newValue, this.defaultConditions);
          } else {
            this.conditionsArray = newValue;
          }
          initializeConditions(this);
        }
      },
      actionsChanged: function (newValue, oldValue) {
        if (this._isReady) {
          removeAllChildren(this.$.actions);
          if (newValue.fields === undefined && newValue.data === undefined) {
            this.actionsArray = JSONSchemaToActionsConfig(newValue, this.defaultActions);
          } else {
            this.actionsArray = newValue;
          }
          initializeActions(this);
        }
      },

      collectConditionsData: function () {
        var conditionsData = this.conditionsBuilder.collectData(this.conditionsHtml);
        return conditionsData;
      },

      collectActionsData: function () {
        var actionsData = this.actionsBuilder.collectData(undefined, this.actionsHtml);
        return actionsData;
      }
    });

    function removeAllChildren(parentElement) {
      for (var i = 0; i < Polymer.dom(parentElement).childNodes.length; i += 1) {
        Polymer.dom(parentElement).removeChild(Polymer.dom(parentElement).childNodes[i]);
      }
    }

    function initializeConditions(pElement) {
      pElement.conditionsBuilder = RuleEngineHelpers.conditionsBuilder(pElement.conditionsArray);
      pElement.conditionsHtml = pElement.conditionsBuilder.buildConditionsHtml();
      Polymer.dom(pElement.$.conditions).appendChild(pElement.conditionsHtml);
    }

    function initializeActions(pElement) {
      pElement.actionsBuilder = RuleEngineHelpers.actionsBuilder(pElement.actionsArray);
      pElement.actionsHtml = pElement.actionsBuilder.buildActionsHtml();
      Polymer.dom(pElement.$.actions).appendChild(pElement.actionsHtml);
    }

    function capitalize(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function JSONSchemaToConditionsConfig(schema, defaultConditions) {
      var result = {
        fields: [],
        data: {
          "all": []
        }
      };

      var properties = schema.properties;

      for (entry in properties) {
        var entryType = properties[entry].type;
        var defaultValue = properties[entry].default !== undefined ? properties[entry].default : '';

        var newField = {
          label: capitalize(entry),
          name: entry + 'Field',
          operators: []
        };
        if (properties[entry].options !== undefined) {
          newField.options = properties[entry].options;
        }
        result.fields.push(newField);
        switch (entryType) {
        case "string":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "text"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "text"
            },
            {
              label: "includes",
              name: "includes",
              fieldType: "text"
            },
            {
              label: "matches regex",
              name: "matchesRegex",
              fieldType: "text"
            },
            {
              label: "is less than",
              name: "lessThan",
              fieldType: "text"
            },
            {
              label: "is less than or equal to",
              name: "lessThanEqual",
              fieldType: "text"
            },
            {
              label: "is greater than",
              name: "greaterThan",
              fieldType: "text"
            },
            {
              label: "is greater than or equal to",
              name: "greaterThanEqual",
              fieldType: "text"
            }
              ];

          if (properties[entry].xtype === "enum" && properties[entry].xvaluelist !== undefined) {
            newField.operators[2].fieldType = "select";
            newField.operators[3].fieldType = "select";

            newField.options = [];
            var valueList = properties[entry].xvaluelist.split(',');
            for (value in valueList) {
              var trimValue = valueList[value].trim();
              newField.options.push({
                name: trimValue,
                label: trimValue
              });
            }
          }

          var compareOptions = getCopyValueFieldOptionsFor(entry, properties);
          if (compareOptions.fields[0].options.length > 0) {
            newField.operators[2].fieldType = "select";
            newField.operators[3].fieldType = "select";

            if (newField.options !== undefined) {
              newField.options = [
                {
                  name: "static",
                  label: "Static",
                  fieldType: "select",
                  options: newField.options
                },
                {
                  name: "field",
                  label: "Field",
                  fieldType: "select",
                  options: []
                }
                  ];
            } else {
              newField.options = [
                {
                  name: "static",
                  label: "Static",
                  fieldType: "text"
                },
                {
                  name: "field",
                  label: "Field",
                  fieldType: "select",
                  options: []
                }
                  ];
            }

            newField.options[1].options = compareOptions.fields[0].options;
          }
          break;
        case "number":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "text"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "text"
            },
            {
              label: "is greater than",
              name: "greaterThan",
              fieldType: "text"
            },
            {
              label: "is greater than or equal to",
              name: "greaterThanEqual",
              fieldType: "text"
            },
            {
              label: "is less than",
              name: "lessThan",
              fieldType: "text"
            },
            {
              label: "is less than or equal to",
              name: "lessThanEqual",
              fieldType: "text"
            }
              ];

          newField.options = [
            {
              name: "static",
              label: "Static",
              fieldType: "text"
            },
            {
              name: "field",
              label: "Field",
              fieldType: "select",
              options: []
            }
              ];

          var compareOptions = getCopyValueFieldOptionsFor(entry, properties);
          if (compareOptions.fields.length > 0) {
            newField.options[1].options = compareOptions.fields[0].options;
          }
          break;
        case "boolean":
          newField.operators = [
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "select"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "select"
            }
              ];
          newField.options = [
            {
              name: "static",
              label: "Static",
              fieldType: "select",
              options: [{
                name: "true",
                label: "true"
              }, {
                name: "false",
                label: "false"
              }]
            },
            {
              name: "field",
              label: "Field",
              fieldType: "select",
              options: []
            }
              ];

          var compareOptions = getCopyValueFieldOptionsFor(entry, properties);
          if (compareOptions.fields.length > 0) {
            newField.options[1].options = compareOptions.fields[0].options;
          }
          break;
        case "enum":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "text"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "text"
            }
              ];

          var compareOptions = getCopyValueFieldOptionsFor(entry, properties);
          if (compareOptions.fields[0].options.length > 0) {
            newField.operators[2].fieldType = "select";

            newField.options = [
              {
                name: "static",
                label: "Static",
                fieldType: "text"
              },
              {
                name: "field",
                label: "Field",
                fieldType: "select",
                options: []
              }
                ];

            newField.options[1].options = compareOptions.fields[0].options;
          }
          break;
        }
        var defaultOperator = newField.operators[0].name;
        if (properties[entry].defaultOperator !== undefined) {
          defaultOperator = properties[entry].defaultOperator;
        }
        if (defaultConditions) {
          result.data.all.push({
            name: newField.name,
            operator: defaultOperator,
            value: defaultValue
          });
        }
      }
      return result;
    }

    function __JSONSchemaToConditionsConfig(schema, defaultConditions) {
      var result = {
        fields: [],
        data: {
          "all": []
        }
      };
      for (entry in schema) {
        var entryType = schema[entry].type;
        var defaultValue = schema[entry].default !== undefined ? schema[entry].default : '';

        var newField = {
          label: capitalize(entry),
          name: entry + 'Field',
          operators: []
        };
        if (schema[entry].options !== undefined) {
          newField.options = schema[entry].options;
        }
        result.fields.push(newField);
        switch (entryType) {
        case "string":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "text"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "text"
            },
            {
              label: "includes",
              name: "includes",
              fieldType: "text"
            },
            {
              label: "matches regex",
              name: "matchesRegex",
              fieldType: "text"
            },
            {
              label: "is less than",
              name: "lessThan",
              fieldType: "text"
            },
            {
              label: "is less than or equal to",
              name: "lessThanEqual",
              fieldType: "text"
            },
            {
              label: "is greater than",
              name: "greaterThan",
              fieldType: "text"
            },
            {
              label: "is greater than or equal to",
              name: "greaterThanEqual",
              fieldType: "text"
            }
              ];
          break;
        case "number":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "text"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "text"
            },
            {
              label: "is greater than",
              name: "greaterThan",
              fieldType: "text"
            },
            {
              label: "is greater than or equal to",
              name: "greaterThanEqual",
              fieldType: "text"
            },
            {
              label: "is less than",
              name: "lessThan",
              fieldType: "text"
            },
            {
              label: "is less than or equal to",
              name: "lessThanEqual",
              fieldType: "text"
            }
              ];
          break;
        case "boolean":
          newField.operators = [
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "select"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "select"
            }
              ];
          break;
        case "enum":
          newField.operators = [
            {
              label: "is present",
              name: "present",
              fieldType: "none"
            },
            {
              label: "is blank",
              name: "blank",
              fieldType: "none"
            },
            {
              label: "is equal to",
              name: "equalTo",
              fieldType: "select"
            },
            {
              label: "is not equal to",
              name: "notEqualTo",
              fieldType: "select"
            }
              ];
          break;
        }
        var defaultOperator = newField.operators[0].name;
        if (schema[entry].defaultOperator !== undefined) {
          defaultOperator = schema[entry].defaultOperator;
        }
        if (defaultConditions) {
          result.data.all.push({
            name: newField.name,
            operator: defaultOperator,
            value: defaultValue
          });
        }
      }
      return result;
    }

    function JSONSchemaToActionsConfig(conditionsConfig, defaultActions) {
      var stateOptions = [
        {
          label: "Optional",
          name: "optional"
        },
        {
          label: "Required",
          name: "required"
        },
        {
          label: "Hidden",
          name: "hidden"
        },
        {
          label: "Disabled",
          name: "disabled"
        }
        ];
      var result = {
        fields: [],
        data: []
      };

      var showAlertField = {
        label: "Show Alert",
        name: "alert",
        fields: [
          {
            label: "Message",
            name: "message",
            fieldType: "textarea"
          }
          ]
      };

      var updateField = {
        label: "Update Field",
        name: "updateField",
        fields: [{
          label: "Field",
          name: "fieldId",
          fieldType: "select",
          options: []
        }]
      };

      var setFieldStateField = {
        label: "Set Field State",
        name: "setFieldState",
        fields: [{
          label: "Field",
          name: "fieldId",
          fieldType: "select",
          options: []
        }]
      };

      var copyFieldValueField = {
        label: "Copy Field Value",
        name: "copyFieldValue",
        fields: [{
          label: "Field",
          name: "fieldId",
          fieldType: "select",
          options: []
        }]
      };

      result.fields.push(showAlertField);
      result.fields.push(updateField);
      result.fields.push(setFieldStateField);
      result.fields.push(copyFieldValueField);
      if (defaultActions) {
        result.data.push({
          name: "action-select",
          value: "alert",
          fields: [{
            name: "message",
            value: "Hello world!"
          }]
        });
      }

      var properties = conditionsConfig.properties;

      for (condition in properties) {
        var condConf = properties[condition];
        var updateFieldOption = {};
        var setFieldStateOption = {};

        switch (condConf.type) {
        case "string":
        case "number":
          if (properties[condition].xtype === "enum" && properties[condition].xvaluelist !== undefined) {
            var updateFieldOptions = [];
            var valueList = properties[condition].xvaluelist.split(',');
            for (value in valueList) {
              var trimValue = valueList[value].trim();
              updateFieldOptions.push({
                name: trimValue,
                label: trimValue
              });
            }
            updateFieldOption = {
              label: capitalize(condition + " to"),
              name: condition + "Field",
              fields: [
                {
                  label: "New Value",
                  name: "newValue",
                  fieldType: "select",
                  options: updateFieldOptions
                }
                  ]
            };
          } else {
            updateFieldOption = {
              label: capitalize(condition + " to"),
              name: condition + "Field",
              fields: [
                {
                  label: "New Value",
                  name: "newValue",
                  fieldType: "text"
                }
                  ]
            };
          }

          setFieldStateOption = {
            label: capitalize(condition),
            name: condition + "Field",
            fields: [
              {
                label: "New state",
                name: "newState",
                fieldType: "select",
                options: stateOptions
              }
                ]
          };
          if (defaultActions) {
            result.data.push({
              name: "action-select",
              value: "updateField",
              fields: [{
                name: "fieldId",
                value: condition + "Field",
                fields: [{
                  name: "newValue",
                  value: ''
                }]
              }]
            });
          }
          break;
        case "bool":
        case "boolean":
          var booleanOptions = [{
            name: "true",
            label: "true"
          }, {
            name: "false",
            label: "false"
          }];
          updateFieldOption = {
            label: capitalize(condition + " to"),
            name: condition + "Field",
            fields: [
              {
                label: "New Value",
                name: "newValue",
                fieldType: "select",
                options: booleanOptions
              }
                ]
          };
          setFieldStateOption = {
            label: capitalize(condition),
            name: condition + "Field",
            fields: [
              {
                label: "New state",
                name: "newState",
                fieldType: "select",
                options: stateOptions
              }
                ]
          };
          if (defaultActions) {
            result.data.push({
              name: "action-select",
              value: "updateField",
              fields: [{
                name: "fieldId",
                value: condition + "Field",
                fields: [{
                  name: "newValue",
                  value: booleanOptions[0].name
                }]
              }]
            });
          }
          break;
        case "enum":
          updateFieldOption = {
            label: capitalize(condition + " to"),
            name: condition + "Field",
            fields: [
              {
                label: "New Value",
                name: "newValue",
                fieldType: "select",
                options: condConf.options
              }
                ]
          };
          setFieldStateOption = {
            label: capitalize(condition),
            name: condition + "Field",
            fields: [
              {
                label: "New state",
                name: "newState",
                fieldType: "select",
                options: stateOptions
              }
                ]
          };
          if (defaultActions) {
            result.data.push({
              name: "action-select",
              value: "updateField",
              fields: [{
                name: "fieldId",
                value: condition + "Field",
                fields: [{
                  name: "newValue",
                  value: condConf.options[1].name
                }]
              }]
            });
          }
          break;
        }

        var copyFieldValueFieldOption = getCopyValueFieldOptionsFor(condition, properties);
        if (copyFieldValueFieldOption.fields[0].options.length > 0) {
          copyFieldValueField.fields[0].options.push(copyFieldValueFieldOption);
        }

        updateField.fields[0].options.push(updateFieldOption);
        setFieldStateField.fields[0].options.push(setFieldStateOption);
      }
      return result;
    }

    function getCopyValueFieldOptionsFor(condition, properties) {
      var result = {
        label: capitalize(condition + " to"),
        name: condition + "Field",
        fields: [
          {
            label: "New Value",
            name: "newValue",
            fieldType: "select",
            options: []
          }
          ]
      };
      var fieldsToAdd = [];

      var condConf = properties[condition];

      for (property in properties) {
        if (condition !== property) { // if names are different
          var propertyConf = properties[property];
          var isTarget = isCopyTarget(condConf, propertyConf);
          if (isTarget) {
            fieldsToAdd.push({
              label: property,
              name: property + "Field"
            });
          }
        }
      }

      result.fields[0].options = fieldsToAdd;
      return result;
    }

    /**
     * Determines whether targetConf can be a copy target for condConf
     * @return true if it can, false otherwise
     */
    function isCopyTarget(condConf, targetConf) {

      if (condConf.type !== targetConf.type) {
        // if both have different type they are not compatible
        return false;
      }

      if (condConf.xtype === undefined && targetConf.xtype === undefined) {
        // if both are of the same type and do not have xtype and they are compatible
        return true;
      }

      if ((condConf.xtype === undefined && targetConf.xtype !== undefined) || (condConf.xtype !== undefined && targetConf.xtype === undefined)) {
        // if both have same type but one has xtype and other doesn't they are not compatible
        return false;
      }

      if (condConf.xtype !== targetConf.xtype) {
        // if both have same type but different xtypes they are not compatible
        return false;
      }

      // at this point both have the same type and same xtype

      if (condConf.xtype === 'enum') {
        // compare xvaluelists
        if (condConf.xvaluelist === undefined || targetConf.xvaluelist === undefined || condConf.xvaluelist !== targetConf.xvaluelist) {
          // if any of the two doesn't have xvaluelist or xvaluelists are different they are not compatible
          return false;
        }
      } else if (condConf.xtype === 'lookup') {
        if (condConf.xurl === undefined || targetConf.xurl === undefined || condConf.xurl !== targetConf.xurl) {
          // if any of the two doesn't have xurl or xurls are different they are not compatible
          return false;
        }
      } else {
        // xtype is not recognized; return false
        return false;
      }

      // source and target are compatible; return true
      return true;
    }

  })();
</script>