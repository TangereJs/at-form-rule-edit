<link rel="import" href="../polymer/polymer.html">

<script src="lib/business-rules/conditions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/actions-builder.js" type="text/javascript"></script>
<script src="lib/business-rules/rule-engine.js" type="text/javascript"></script>

<polymer-element name="at-form-rule-edit">

  <template>
    <style>
      #conditions, #actions {
        margin: 20px 0;
      }

        #conditions > .conditional > .remove, #actions > .conditional > .remove {
          display: none;
        }

      #error_message_wrapper {
        margin: 20px 0;
      }

      .conditional {
        padding-left: 60px;
      }

        .conditional .all-any-none-wrapper {
          margin: 5px 20px 5px -60px;
          display: -moz-inline-stack;
          display: inline-block;
        }

      .all-any-none {
        margin-right: 10px;
      }

      .all-any-none-wrapper, .conditional, .rule {
        margin: 10px 0;
      }

      .add-rule, .add-condition, .remove {
        margin: auto 5px;
      }

      .remove {
        color: red;
      }

      .rule input {
        width: 250px;
      }

      .rule select {
        margin-right: 10px;
      }

      .action-buttons {
        margin: 20px 0;
      }

      .action {
        margin: 10px 0;
      }

        .action .subfields, .action .subfields .field {
          display: inline;
        }

        .action label {
          display: none;
        }

        .action select, .action input, .action textarea {
          margin-right: 10px;
        }

        .action textarea, .action input {
          width: 250px;
        }

        .action textarea {
          vertical-align: top;
          height: 50px;
        }
    </style>

    <h3>When these conditions are met...</h3>
    <div id="conditions"></div>

    <h3>Do these actions...</h3>
    <div id="actions"></div>

    <content></content>
  </template>

  <script>
    (function () {
      Polymer('at-form-rule-edit', {
        publish: {
          conditions: [],
          actions: [],
          conditionsBuilder: {},
          conditionsHtml: '',
          actionsBuilder: {},
          actionsHtml: '',
          defaultConditions: true,
          defaultActions: true
        },
        conditionsArray: [], // this is used to avoid double conditions object
        actionsArray: [], // this is used to avoid double conditions object
        ready: function () {
        },
        conditionsChanged: function (oldValue, newValue) {
          if (newValue.fields === undefined && newValue.data === undefined) {
            this.conditionsArray = JSONSchemaToConditionsConfig(newValue, this.defaultConditions);
          } else {
            this.conditionsArray = newValue;
          }
          initializeConditions(this);
        },
        actionsChanged: function (oldValue, newValue) {
          if (newValue.fields === undefined && newValue.data === undefined) {
            this.actionsArray = JSONSchemaToActionsConfig(newValue, this.defaultActions);
          } else {
            this.actionsArray = newValue;
          }
          initializeActions(this);
        },

        collectConditionsData: function () {
          var conditionsData = this.conditionsBuilder.collectData(this.conditionsHtml);
          return conditionsData;
        },

        collectActionsData: function () {
          var actionsData = this.actionsBuilder.collectData(undefined, this.actionsHtml);
          return actionsData;
        }
      });

      function initializeConditions(pElement) {
        pElement.conditionsBuilder = RuleEngineHelpers.conditionsBuilder(pElement.conditionsArray);
        pElement.conditionsHtml = pElement.conditionsBuilder.buildConditionsHtml();
        pElement.$.conditions.appendChild(pElement.conditionsHtml);
      }

      function initializeActions(pElement) {
        pElement.actionsBuilder = RuleEngineHelpers.actionsBuilder(pElement.actionsArray);
        pElement.actionsHtml = pElement.actionsBuilder.buildActionsHtml();
        pElement.$.actions.appendChild(pElement.actionsHtml);
      }

      function capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function JSONSchemaToConditionsConfig(schema, defaultConditions) {
        var result = {
          fields: [],
          data: { "all": [] }
        };
        for (entry in schema) {
          var entryType = schema[entry].type;
          var defaultValue = schema[entry].default !== undefined ? schema[entry].default : '';

          var newField = { label: capitalize(entry), name: entry + 'Field', operators: [] };
          if (schema[entry].options !== undefined) {
            newField.options = schema[entry].options;
          }
          result.fields.push(newField);
          switch (entryType) {
            case "string":
              newField.operators = [
                { label: "is present", name: "present", fieldType: "none" },
                { label: "is blank", name: "blank", fieldType: "none" },
                { label: "is equal to", name: "equalTo", fieldType: "text" },
                { label: "is not equal to", name: "notEqualTo", fieldType: "text" },
                { label: "includes", name: "includes", fieldType: "text" },
                { label: "matches regex", name: "matchesRegex", fieldType: "text" },
                { label: "is less than", name: "lessThan", fieldType: "text" },
                { label: "is less than or equal to", name: "lessThanEqual", fieldType: "text" },
                { label: "is greater than", name: "greaterThan", fieldType: "text" },
                { label: "is greater than or equal to", name: "greaterThanEqual", fieldType: "text" }
              ];
              break;
            case "number":
              newField.operators = [
                 { label: "is present", name: "present", fieldType: "none" },
                 { label: "is blank", name: "blank", fieldType: "none" },
                 { label: "is equal to", name: "equalTo", fieldType: "text" },
                 { label: "is not equal to", name: "notEqualTo", fieldType: "text" },
                 { label: "is greater than", name: "greaterThan", fieldType: "text" },
                 { label: "is greater than or equal to", name: "greaterThanEqual", fieldType: "text" },
                 { label: "is less than", name: "lessThan", fieldType: "text" },
                 { label: "is less than or equal to", name: "lessThanEqual", fieldType: "text" }
              ];
              break;
            case "boolean":
              newField.operators = [
                 { label: "is blank", name: "blank", fieldType: "none" },
                 { label: "is equal to", name: "equalTo", fieldType: "select" },
                 { label: "is not equal to", name: "notEqualTo", fieldType: "select" }
              ];
              break;
            case "enum":
              newField.operators = [
                 { label: "is present", name: "present", fieldType: "none" },
                 { label: "is blank", name: "blank", fieldType: "none" },
                 { label: "is equal to", name: "equalTo", fieldType: "select" },
                 { label: "is not equal to", name: "notEqualTo", fieldType: "select" }
              ];
              break;
          }
          var defaultOperator = newField.operators[0].name;
          if (schema[entry].defaultOperator !== undefined) {
            defaultOperator = schema[entry].defaultOperator;
          }
          if (defaultConditions) {
            result.data.all.push({
              name: newField.name,
              operator: defaultOperator,
              value: defaultValue
            });
          }
        }
        return result;
      }

      function JSONSchemaToActionsConfig(conditionsConfig, defaultActions) {
        var stateOptions = [
            { label: "Optional", name: "optional" },
            { label: "Required", name: "required" },
            { label: "Hidden", name: "hidden" },
            { label: "Disabled", name: "disabled" }
        ];
        var result = {
          fields: [],
          data: []
        };

        var showAlertField = {
          label: "Show Alert",
          name: "alert",
          fields: [
            { label: "Message", name: "message", fieldType: "textarea" }
          ]
        };

        var updateField = {
          label: "Update Field",
          name: "updateField",
          fields: [{ label: "Field", name: "fieldId", fieldType: "select", options: [] }]
        };

        var setFieldStateField = {
          label: "Set Field State",
          name: "setFieldState",
          fields: [{ label: "Field", name: "fieldId", fieldType: "select", options: [] }]
        };

        result.fields.push(showAlertField);
        result.fields.push(updateField);
        result.fields.push(setFieldStateField);
        if (defaultActions) {
          result.data.push({
            name: "action-select", value: "alert", fields: [{ name: "message", value: "Hello world!" }]
          });
        }

        for (condition in conditionsConfig) {
          var condConf = conditionsConfig[condition];
          var updateFieldOption = {};
          var setFieldStateOption = {};

          switch (condConf.type) {
            case "string":
            case "number":
              updateFieldOption = {
                label: capitalize(condition + " to"), name: condition + "Field", fields: [
                 { label: "New Value", name: "newValue", fieldType: "text" }
                ]
              };
              setFieldStateOption = {
                label: capitalize(condition), name: condition + "Field", fields: [
                 { label: "New state", name: "newState", fieldType: "select", options: stateOptions }
                ]
              };
              if (defaultActions) {
                result.data.push({
                  name: "action-select", value: "updateField", fields: [{ name: "fieldId", value: condition + "Field", fields: [{ name: "newValue", value: '' }] }]
                });
              }
              break;
            case "bool":
            case "boolean":
              updateFieldOption = {
                label: capitalize(condition + " to"), name: condition + "Field", fields: [
                 { label: "New Value", name: "newValue", fieldType: "select", options: condConf.options }
                ]
              };
              setFieldStateOption = {
                label: capitalize(condition), name: condition + "Field", fields: [
                 { label: "New state", name: "newState", fieldType: "select", options: stateOptions }
                ]
              };
              if (defaultActions) {
                result.data.push({
                  name: "action-select", value: "updateField", fields: [{ name: "fieldId", value: condition + "Field", fields: [{ name: "newValue", value: condConf.options[0].name }] }]
                });
              }
              break;
            case "enum":
              updateFieldOption = {
                label: capitalize(condition + " to"), name: condition + "Field", fields: [
                 { label: "New Value", name: "newValue", fieldType: "select", options: condConf.options }
                ]
              };
              setFieldStateOption = {
                label: capitalize(condition), name: condition + "Field", fields: [
                 { label: "New state", name: "newState", fieldType: "select", options: stateOptions }
                ]
              };
              if (defaultActions) {
                result.data.push({
                  name: "action-select", value: "updateField", fields: [{ name: "fieldId", value: condition + "Field", fields: [{ name: "newValue", value: condConf.options[1].name }] }]
                });
              }
              break;
          }

          updateField.fields[0].options.push(updateFieldOption);
          setFieldStateField.fields[0].options.push(setFieldStateOption);
        }
        return result;
      }

    })();
  </script>

</polymer-element>
