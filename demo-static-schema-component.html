<link rel="import" href="at-form-rule-edit.html">

<polymer-element name="demo-static-schema-component">
  <template>
    <style>
      #demoForm {
        position: relative;
        top: 0px;
        right: 0px;
        padding: 20px;
        width: 300px;
        background: #ddd;
      }

        #demoForm div {
          margin: 10px 0;
        }

      #peraForm {
        position: relative;
        top: 0px;
        right: 0px;
        padding: 20px;
        width: 300px;
        background: #ddd;
      }

        #peraForm div {
          margin: 10px 0;
        }
    </style>

    <h3>Demo static schema</h3>
    <at-form-rule-edit id="peraRules">
      <form id="peraForm">
        <h3>Try Changing These Values...</h3>
        <div><label>Damage</label><input type="text" id="damageField" /></div>
        <div><label>Health</label><input type="text" id="healthField" /></div>
        <div>
          <label>Enemy</label>
          <select id="enemyField"></select>
        </div>
        <div><button type="submit" id="perasubmit">Run Conditions and Actions</button></div>
      </form>
    </at-form-rule-edit>
  </template>

  <script>
    (function () {


      Polymer('demo-static-schema-component', {
        ready: function () {

          var enemyOptions = [
            { label: "", name: "" },
            { label: "Enemy1", name: "enemy1" },
            { label: "Enemy2", name: "enemy2" },
            { label: "Enemy3", name: "enemy3" },
          ];

          // this is for the peraForm
          var peraConditionsConfig = {
            fields: [
              {
                label: "Damage", name: "damageField", operators: [
                 { label: "is equal to", name: "equalTo", fieldType: "text" },
                 { label: "is not equal to", name: "notEqualTo", fieldType: "text" },
                ]
              },
              {
                label: "Health", name: "healthField", operators: [
                 { label: "is greater than or equal to", name: "greaterThanEqual", fieldType: "text" },
                 { label: "is less than or equal to", name: "lessThanEqual", fieldType: "text" },
                ]
              },
              {
                label: "Enemy", name: "enemyField", options: enemyOptions, operators: [
                 { label: "is present", name: "present", fieldType: "none" },
                 { label: "is blank", name: "blank", fieldType: "none" },
                 { label: "is equal to", name: "equalTo", fieldType: "select" },
                 { label: "is not equal to", name: "notEqualTo", fieldType: "select" },
                ]
              }
            ],
            data: {
              "all": [
                { name: "damageField", operator: "equalTo", value: "50" },
                { name: "healthField", operator: "lessThanEqual", value: "49" }
              ]
            }
          }; // end of conditions config

          var peraActionsConfig = {
            fields: [
              {
                label: "Show Alert", name: "alert", fields: [
                 { label: "Message", name: "message", fieldType: "textarea" }
                ]
              },
              {
                label: "Update Field", name: "updateField", fields: [
                 {
                   label: "Field", name: "fieldId", fieldType: "select", options: [
                    {
                      label: "Damage to", name: "damageField", fields: [
                       { label: "New Value", name: "newValue", fieldType: "text" }
                      ]
                    },
                    {
                      label: "Health to", name: "healthField", fields: [
                       { label: "New Value", name: "newValue", fieldType: "text" }
                      ]
                    },
                    {
                      label: "Enemy to", name: "enemyField", fields: [
                       { label: "New Value", name: "newValue", fieldType: "select", options: enemyOptions }
                      ]
                    }
                   ]
                 },
                ]
              }
            ],
            data: [
              {
                name: "action-select", value: "alert", fields: [
                 { name: "message", value: "You have been ... !" }
                ]
              },
              {
                name: "action-select", value: "updateField", fields: [
                 {
                   name: "fieldId", value: "enemyField", fields: [
                    { name: "newValue", value: "enemy3" }
                   ]
                 }
                ]
              }
            ]
          }; // end of actions config

          this.$.peraRules.conditions = peraConditionsConfig;
          this.$.peraRules.actions = peraActionsConfig;

          initializePeraForm(this);

          function initializePeraForm(pElement) {
            for (var i = 0; i < enemyOptions.length; i++) {
              var o = enemyOptions[i];
              var optionChild = document.createElement("option");
              optionChild.value = o.name;
              optionChild.text = o.label;
              pElement.$.enemyField.appendChild(optionChild);
            }

            pElement.$.perasubmit.addEventListener('click', function (e) {
              e.preventDefault();
              var lConditions = pElement.$.peraRules.collectConditionsData();
              var lActions = pElement.$.peraRules.collectActionsData();

              var engine = new RuleEngine({
                conditions: lConditions,
                actions: lActions
              });
              var conditionsAdapter = {
                damageField: pElement.$.damageField.value,
                healthField: pElement.$.healthField.value,
                enemyField: pElement.$.enemyField.value
              };
              var actionsAdapter = {
                alert: function (data) {
                  alert(data.find("message"));
                },
                updateField: function (data) {
                  console.log("data", data);
                  var fieldId = data.find("fieldId");
                  console.log("fieldId", fieldId);
                  var field = pElement.$[fieldId];
                  var val = data.find("fieldId", "newValue");
                  field.value = val;
                }
              };
              engine.run(conditionsAdapter, actionsAdapter);
            });
          }
        }
      });
    })();
  </script>
</polymer-element>
